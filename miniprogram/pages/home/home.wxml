<!-- é¦–é¡µ -->
<view class="home-page">
  <!-- å·²ç™»å½•ï¼šæŒ‚åˆ€/æ¬ç –å®Œæ•´åŠŸèƒ½ -->
  <block wx:if="{{isLoggedIn}}">
    <!-- æ ‡é¢˜å¡ç‰‡ -->
    <view class="header-card">
      <view class="header-row">
        <text class="title-text">æŒ‚åˆ€/æ¬ç –</text>
        <view class="filter-btn" bindtap="toggleFilter">
          <text>ç­›é€‰</text>
          <text class="filter-icon">{{showFilter ? 'â–²' : 'â–¼'}}</text>
        </view>
      </view>
    </view>

    <!-- å¹³å°é€‰æ‹© -->
    <view class="platform-card">
      <view class="platform-item">
        <text class="platform-label">ä¹°å…¥å¹³å°</text>
        <picker mode="selector" range="{{platforms}}" bindchange="onSourceChange" value="{{sourceIndex}}">
          <view class="platform-select">
            <image class="select-icon" src="/images/{{platformKeys[sourceIndex]}}.png" mode="aspectFit"></image>
            <text class="select-text">{{platforms[sourceIndex]}}</text>
            <text class="select-arrow">â–¼</text>
          </view>
        </picker>
      </view>
      <view class="platform-item">
        <text class="platform-label">å–å‡ºå¹³å°</text>
        <picker mode="selector" range="{{platforms}}" bindchange="onTargetChange" value="{{targetIndex}}">
          <view class="platform-select">
            <image class="select-icon" src="/images/{{platformKeys[targetIndex]}}.png" mode="aspectFit"></image>
            <text class="select-text">{{platforms[targetIndex]}}</text>
            <text class="select-arrow">â–¼</text>
          </view>
        </picker>
      </view>
    </view>

    <!-- ç­›é€‰é¢æ¿ -->
    <view class="filter-panel {{showFilter ? 'show' : ''}}">
      <!-- ä»·æ ¼èŒƒå›´ -->
      <view class="filter-row">
        <view class="filter-group">
          <text class="filter-label">æœ€ä½ä»·æ ¼</text>
          <input class="filter-input" type="digit" placeholder="0" value="{{minPrice}}" bindinput="onMinPriceInput" />
        </view>
        <text class="filter-separator">~</text>
        <view class="filter-group">
          <text class="filter-label">æœ€é«˜ä»·æ ¼</text>
          <input class="filter-input" type="digit" placeholder="10000" value="{{maxPrice}}" bindinput="onMaxPriceInput" />
        </view>
      </view>

      <!-- åœ¨å”®é‡å’Œä»·æ ¼å·® -->
      <view class="filter-row">
        <view class="filter-group">
          <text class="filter-label">æœ€å°åœ¨å”®é‡</text>
          <input class="filter-input" type="number" placeholder="0" value="{{minSellNum}}" bindinput="onMinSellNumInput" />
        </view>
        <view class="filter-group">
          <text class="filter-label">æœ€å°ä»·æ ¼å·®</text>
          <input class="filter-input" type="digit" placeholder="0" value="{{minDiff}}" bindinput="onMinDiffInput" />
        </view>
      </view>

      <!-- ç±»åˆ«å’Œæ’åº -->
      <view class="filter-row">
        <view class="filter-group">
          <text class="filter-label">ç±»åˆ«</text>
          <picker mode="selector" range="{{categoryOptions}}" bindchange="onCategoryChange" value="{{categoryIndex}}">
            <view class="filter-picker">
              <text>{{categoryOptions[categoryIndex]}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        <view class="filter-group">
          <text class="filter-label">æ’åº</text>
          <picker mode="selector" range="{{sortOptions}}" bindchange="onSortChange" value="{{sortIndex}}">
            <view class="filter-picker">
              <text>{{sortOptions[sortIndex]}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>

      <!-- æŒ‰é’® -->
      <view class="filter-actions">
        <button class="btn-confirm" bindtap="doSearch">ç¡®å®š</button>
      </view>
    </view>

    <!-- æ•°æ®ç»Ÿè®¡ -->
    <view class="data-stats" wx:if="{{skinList.length > 0}}">
      <text>å…± {{total}} æ¡æ•°æ®</text>
    </view>
  </block>

  <!-- æœªç™»å½•ï¼šæ¬ç –åˆ©æ¶¦æ¦œ -->
  <block wx:else>
    <view class="header-card">
      <view class="header-title">
        <text class="title-text">æ¬ç –åˆ©æ¶¦æ¦œ</text>
      </view>
      <view class="header-desc">
        <text class="desc-text">åˆ©æ¶¦ç‡TOP10</text>
      </view>
    </view>

    <view class="login-tip" bindtap="goLogin">
      <text class="tip-text">ğŸ ç™»å½•åå¯ç­›é€‰ã€æŸ¥çœ‹å®Œæ•´æ•°æ®</text>
      <text class="tip-btn">ç«‹å³ç™»å½• ></text>
    </view>
  </block>

  <!-- æ•°æ®åˆ—è¡¨ -->
  <view class="skin-list" wx:if="{{!loading || skinList.length > 0}}">
    <view class="skin-item-wrapper" wx:for="{{skinList}}" wx:key="market_hash_name">
      <view class="skin-item" data-hashname="{{item.market_hash_name}}" bindtap="goDetail">
        <view class="rank-badge {{index < 3 ? 'top' : ''}}" wx:if="{{!isLoggedIn}}">
          <text>{{index + 1}}</text>
        </view>
        
        <!-- å·¦ä¾§ï¼šå›¾ç‰‡å’Œå¹³å°æ•°æ®æŒ‰é’® -->
        <view class="skin-left {{isLoggedIn ? '' : 'with-rank'}}">
          <image class="skin-img" src="{{item.image_url}}" mode="aspectFit"></image>
          <view class="platform-data-btn" wx:if="{{item.platform_list && item.platform_list.length > 0}}" data-index="{{index}}" catchtap="togglePlatformData">
            <text>å¹³å°æ•°æ®</text>
            <text class="btn-arrow">{{item.showPlatform ? 'â–²' : 'â–¼'}}</text>
          </view>
        </view>
        
        <view class="skin-info">
          <text class="skin-name">{{item.name}}</text>
          
          <view class="price-row">
            <view class="price-item">
              <image class="price-icon" src="{{isLoggedIn ? '/images/' + platformKeys[sourceIndex] + '.png' : '/images/uu.png'}}" mode="aspectFit"></image>
              <text class="price source">Â¥{{item.sourcePriceText}}</text>
            </view>
            <view class="arrow-wrapper">
              <view class="arrow-line"></view>
              <view class="arrow-head"></view>
            </view>
            <view class="price-item">
              <image class="price-icon" src="{{isLoggedIn ? '/images/' + platformKeys[targetIndex] + '.png' : '/images/buff.png'}}" mode="aspectFit"></image>
              <text class="price target">Â¥{{item.targetPriceText}}</text>
            </view>
          </view>
          
          <view class="profit-row">
            <view class="profit-item">
              <text class="profit-label">ä»·å·®</text>
              <text class="profit-value diff">+Â¥{{item.priceDiffText}}</text>
            </view>
            <view class="profit-item">
              <text class="profit-label">åˆ©æ¶¦ç‡</text>
              <text class="profit-value rate {{item.profitClass}}">{{item.profitRateText}}</text>
            </view>
            <view class="profit-item" wx:if="{{item.turn_over}}">
              <text class="profit-label">æˆäº¤é‡</text>
              <text class="profit-value count">{{item.turn_over}}</text>
            </view>
            <view class="profit-item" wx:if="{{item.sell_count}}">
              <text class="profit-label">åœ¨å”®æ•°é‡</text>
              <text class="profit-value count">{{item.sell_count}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å„å¹³å°æ•°æ®å±•å¼€åŒºåŸŸ -->
      <view class="platform-data-panel {{item.showPlatform ? 'show' : ''}}" wx:if="{{item.platform_list && item.platform_list.length > 0}}">
        <view class="platform-data-item" wx:for="{{item.platform_list}}" wx:for-item="p" wx:key="platformItemId">
          <view class="platform-name-row">
            <text class="platform-name">{{p.platformName}}</text>
          </view>
          <view class="platform-price-row">
            <view class="platform-price-item">
              <text class="platform-price-label">åœ¨å”®ä»·</text>
              <text class="platform-price-value sell">Â¥{{p.sellPrice}}</text>
              <text class="platform-price-count">({{p.sellCount}})</text>
            </view>
            <view class="platform-price-item">
              <text class="platform-price-label">æ±‚è´­ä»·</text>
              <text class="platform-price-value bid">Â¥{{p.biddingPrice}}</text>
              <text class="platform-price-count">({{p.biddingCount}})</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="empty" wx:if="{{!loading && skinList.length === 0}}">
      <text class="empty-icon">ğŸ“¦</text>
      <text class="empty-text">æš‚æ— æ•°æ®</text>
    </view>
  </view>

  <view class="loading" wx:if="{{loading && skinList.length === 0}}">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <view class="load-more" wx:if="{{isLoggedIn && hasMore && skinList.length > 0}}" bindtap="loadMore">
    <text>{{loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}</text>
  </view>

  <view class="no-more" wx:if="{{isLoggedIn && !hasMore && skinList.length > 0}}">
    <text>â€” æ²¡æœ‰æ›´å¤šäº† â€”</text>
  </view>
</view>
