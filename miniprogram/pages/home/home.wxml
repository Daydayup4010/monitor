<!-- é¦–é¡µ -->
<view class="home-page">
  <!-- å·²ç™»å½•ï¼šæŒ‚åˆ€/æ¬ç –å®Œæ•´åŠŸèƒ½ -->
  <block wx:if="{{isLoggedIn}}">
    <!-- æ ‡é¢˜å¡ç‰‡ -->
    <view class="header-card">
      <view class="header-row">
        <text class="title-text">æŒ‚åˆ€/æ¬ç –</text>
        <view class="filter-btn" bindtap="toggleFilter">
          <text>ç­›é€‰</text>
          <text class="filter-icon {{showFilter ? 'expanded' : ''}}">â–¼</text>
        </view>
      </view>
    </view>

    <!-- å¹³å°é€‰æ‹© -->
    <view class="platform-card">
      <view class="platform-row">
        <!-- ä¹°å…¥å¹³å° -->
        <view class="platform-item">
          <text class="platform-label">ä¹°å…¥å¹³å°</text>
          <picker mode="selector" range="{{platforms}}" bindchange="onSourceChange" value="{{sourceIndex}}">
            <view class="platform-picker">
              <image class="picker-icon" src="/images/{{platformKeys[sourceIndex]}}.png" mode="aspectFit"></image>
              <text class="picker-text">{{platforms[sourceIndex]}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <!-- å–å‡ºå¹³å° -->
        <view class="platform-item">
          <text class="platform-label">å–å‡ºå¹³å°</text>
          <picker mode="selector" range="{{platforms}}" bindchange="onTargetChange" value="{{targetIndex}}">
            <view class="platform-picker">
              <image class="picker-icon" src="/images/{{platformKeys[targetIndex]}}.png" mode="aspectFit"></image>
              <text class="picker-text">{{platforms[targetIndex]}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>
    </view>

    <!-- è´­ä¹°/å‡ºå”®æ–¹æ¡ˆ -->
    <view class="scheme-card">
      <!-- è´­ä¹°æ–¹æ¡ˆ -->
      <view class="scheme-row">
        <text class="scheme-label">è´­ä¹°æ–¹æ¡ˆ:</text>
        <view class="scheme-tabs">
          <view class="scheme-tab {{buyType === 'sell' ? 'active' : ''}}" bindtap="onBuyTypeChange" data-type="sell">
            {{platforms[sourceIndex]}}åœ¨å”®ä»·è´­ä¹°
          </view>
          <view class="scheme-tab {{buyType === 'bidding' ? 'active' : ''}}" bindtap="onBuyTypeChange" data-type="bidding">
            {{platforms[sourceIndex]}}æ±‚è´­ä»·è´­ä¹°
          </view>
        </view>
      </view>
      <!-- å‡ºå”®æ–¹æ¡ˆ -->
      <view class="scheme-row">
        <text class="scheme-label">å‡ºå”®æ–¹æ¡ˆ:</text>
        <view class="scheme-tabs">
          <view class="scheme-tab {{sellType === 'sell' ? 'active' : ''}}" bindtap="onSellTypeChange" data-type="sell">
            {{platforms[targetIndex]}}æŒ‚åº•ä»·
          </view>
          <view class="scheme-tab {{sellType === 'bidding' ? 'active' : ''}}" bindtap="onSellTypeChange" data-type="bidding">
            {{platforms[targetIndex]}}ä¸¢æ±‚è´­
            <text class="fast-tag">å¿«</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç±»åˆ«æ ‡ç­¾ï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰ -->
    <scroll-view class="category-scroll" scroll-x="true" enhanced="true" show-scrollbar="false">
      <view class="category-tags">
        <view 
          class="category-tag {{categoryIndex === index ? 'active' : ''}}" 
          wx:for="{{categoryOptions}}" 
          wx:key="index"
          data-index="{{index}}"
          bindtap="onCategoryTap"
        >{{item}}</view>
      </view>
    </scroll-view>

    <!-- æ’åºæ ‡ç­¾ -->
    <view class="sort-bar">
      <view 
        class="sort-tag {{sortIndex === index ? 'active' : ''}}" 
        wx:for="{{sortOptions}}" 
        wx:key="index"
        data-index="{{index}}"
        bindtap="onSortTap"
      >{{item}}</view>
    </view>

    <!-- å½“å‰é€‰é¡¹æè¿° -->
    <view class="filter-desc">
      <text class="desc-label">å½“å‰é€‰é¡¹æè¿°ï¼š</text>
      <text class="desc-content">{{filterDescription}}</text>
    </view>

    <!-- ç­›é€‰é¢æ¿ -->
    <view class="filter-panel {{showFilter ? 'show' : ''}}">
      <!-- ä»·æ ¼èŒƒå›´ -->
      <view class="filter-row">
        <view class="filter-group">
          <text class="filter-label">æœ€ä½ä»·æ ¼</text>
          <input class="filter-input" type="digit" placeholder="0" value="{{minPrice}}" bindinput="onMinPriceInput" />
        </view>
        <text class="filter-separator">~</text>
        <view class="filter-group">
          <text class="filter-label">æœ€é«˜ä»·æ ¼</text>
          <input class="filter-input" type="digit" placeholder="10000" value="{{maxPrice}}" bindinput="onMaxPriceInput" />
        </view>
      </view>

      <!-- åœ¨å”®é‡å’Œä»·æ ¼å·® -->
      <view class="filter-row">
        <view class="filter-group">
          <text class="filter-label">æœ€å°åœ¨å”®é‡</text>
          <input class="filter-input" type="number" placeholder="0" value="{{minSellNum}}" bindinput="onMinSellNumInput" />
        </view>
        <view class="filter-group">
          <text class="filter-label">æœ€å°ä»·æ ¼å·®</text>
          <input class="filter-input" type="digit" placeholder="0" value="{{minDiff}}" bindinput="onMinDiffInput" />
        </view>
      </view>

      <!-- æŒ‰é’® -->
      <view class="filter-actions">
        <button class="btn-confirm" bindtap="doSearch">ç¡®å®š</button>
      </view>
    </view>

    <!-- æ•°æ®ç»Ÿè®¡ -->
    <view class="data-stats" wx:if="{{skinList.length > 0}}">
      <text>å…± {{total}} æ¡æ•°æ®</text>
    </view>
  </block>

  <!-- æœªç™»å½•ï¼šæ¬ç –åˆ©æ¶¦æ¦œ -->
  <block wx:else>
    <view class="header-card">
      <view class="header-title">
        <text class="title-text">æ¬ç –åˆ©æ¶¦æ¦œ</text>
      </view>
      <view class="header-desc">
        <text class="desc-text">åˆ©æ¶¦ç‡TOP10</text>
      </view>
    </view>

    <view class="login-tip" bindtap="goLogin">
      <text class="tip-text">ğŸ ç™»å½•åå¯ç­›é€‰ã€æŸ¥çœ‹å®Œæ•´æ•°æ®</text>
      <text class="tip-btn">ç«‹å³ç™»å½• ></text>
    </view>
  </block>

  <!-- æ•°æ®åˆ—è¡¨ -->
  <view class="skin-list" wx:if="{{!loading || skinList.length > 0}}">
    <view class="skin-item-wrapper" wx:for="{{skinList}}" wx:key="market_hash_name">
      <view class="skin-item" data-hashname="{{item.market_hash_name}}" bindtap="goDetail">
        <view class="rank-badge {{index < 3 ? 'top' : ''}}" wx:if="{{!isLoggedIn}}">
          <text>{{index + 1}}</text>
        </view>
        
        <!-- å·¦ä¾§ï¼šå›¾ç‰‡å’Œå¹³å°æ•°æ®æŒ‰é’® -->
        <view class="skin-left {{isLoggedIn ? '' : 'with-rank'}}">
          <image class="skin-img" src="{{item.image_url}}" mode="aspectFit"></image>
          <view class="platform-data-wrapper" wx:if="{{item.platform_list && item.platform_list.length > 0}}">
            <view class="platform-data-btn" data-index="{{index}}" catchtap="togglePlatformData">
              <text>å¹³å°æ•°æ®</text>
              <text class="btn-arrow {{item.showPlatform ? 'expanded' : ''}}">â–¼</text>
            </view>
            <view class="lower-price-tip" wx:if="{{item.hasLowerPrice}}">æœ‰æ›´ä½ä»·æ ¼å¹³å°</view>
          </view>
        </view>
        
        <view class="skin-info">
          <text class="skin-name">{{item.name}}</text>
          
          <view class="price-row">
            <view class="price-item">
              <image class="price-icon" src="{{isLoggedIn ? '/images/' + platformKeys[sourceIndex] + '.png' : '/images/uu.png'}}" mode="aspectFit"></image>
              <text class="price source">Â¥{{item.sourcePriceText}}</text>
            </view>
            <view class="arrow-wrapper">
              <view class="arrow-line"></view>
              <view class="arrow-head"></view>
            </view>
            <view class="price-item">
              <image class="price-icon" src="{{isLoggedIn ? '/images/' + platformKeys[targetIndex] + '.png' : '/images/buff.png'}}" mode="aspectFit"></image>
              <text class="price target">Â¥{{item.targetPriceText}}</text>
            </view>
          </view>
          
          <view class="profit-row">
            <view class="profit-item">
              <text class="profit-label">ä»·å·®</text>
              <text class="profit-value diff">+Â¥{{item.priceDiffText}}</text>
            </view>
            <view class="profit-item">
              <text class="profit-label">åˆ©æ¶¦ç‡</text>
              <text class="profit-value rate {{item.profitClass}}">{{item.profitRateText}}</text>
            </view>
            <view class="profit-item" wx:if="{{item.turn_over}}">
              <text class="profit-label">æˆäº¤é‡</text>
              <text class="profit-value count">{{item.turn_over}}</text>
            </view>
            <view class="profit-item" wx:if="{{item.sell_count}}">
              <text class="profit-label">åœ¨å”®æ•°é‡</text>
              <text class="profit-value count">{{item.sell_count}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å„å¹³å°æ•°æ®å±•å¼€åŒºåŸŸ -->
      <view class="platform-data-panel {{item.showPlatform ? 'show' : ''}}" wx:if="{{item.platform_list && item.platform_list.length > 0}}">
        <!-- å–å‡ºå¹³å°æŠ¬å¤´ï¼ˆé«˜äº®åŒºå—ï¼‰ -->
        <view class="target-platform-header" wx:if="{{item.targetPlatformData}}">
          <view class="target-platform-info">
            <image class="target-platform-icon" src="{{item.targetPlatformData.icon}}" mode="aspectFit"></image>
            <text class="target-platform-name">{{item.targetPlatformData.platformName}}</text>
          </view>
          <view class="target-platform-prices">
            <text class="target-price-item">åœ¨å”®ä»·(Â¥): <text class="sell">{{item.targetPlatformData.sellPrice}}</text>({{item.targetPlatformData.sellCount}})</text>
            <text class="target-price-item">æ±‚è´­ä»·(Â¥): <text class="bid">{{item.targetPlatformData.biddingPrice}}</text>({{item.targetPlatformData.biddingCount}})</text>
          </view>
        </view>
        <!-- å…¶ä»–å¹³å°è¡¨æ ¼ -->
        <view class="other-platforms-table" wx:if="{{item.otherPlatforms && item.otherPlatforms.length > 0}}">
          <view class="platform-table-header">
            <text class="col-platform">å¹³å°</text>
            <text class="col-sell">åœ¨å”®ä»·(Â¥)</text>
            <text class="col-bid">æ±‚è´­ä»·(Â¥)</text>
            <text class="col-diff">ä»·æ ¼å·®(Â¥)</text>
          </view>
          <view class="platform-table-row" wx:for="{{item.otherPlatforms}}" wx:for-item="p" wx:key="platformItemId">
            <view class="col-platform">
              <image class="platform-icon-small" src="{{p.icon}}" mode="aspectFit"></image>
              <text>{{p.platformName}}</text>
            </view>
            <view class="col-sell">
              <text class="sell-price">{{p.sellPrice}}</text>
              <text class="count">({{p.sellCount}})</text>
            </view>
            <view class="col-bid">
              <text class="bid-price">{{p.biddingPrice}}</text>
              <text class="count">({{p.biddingCount}})</text>
            </view>
            <text class="col-diff diff-price">{{p.price_diff || '-'}}</text>
          </view>
        </view>
      </view>
    </view>

    <view class="empty" wx:if="{{!loading && skinList.length === 0}}">
      <text class="empty-icon">ğŸ“¦</text>
      <text class="empty-text">æš‚æ— æ•°æ®</text>
    </view>
  </view>

  <view class="loading" wx:if="{{loading && skinList.length === 0}}">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- åº•éƒ¨åŠ è½½çŠ¶æ€ -->
  <view class="load-status" wx:if="{{isLoggedIn && skinList.length > 0}}">
    <view class="loading-more" wx:if="{{hasMore && loading}}">
      <view class="loading-spinner"></view>
      <text>åŠ è½½ä¸­...</text>
    </view>
    <view class="has-more-tip" wx:elif="{{hasMore && !loading}}">
      <text>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>
    <view class="no-more" wx:else>
      <text>â€” æ²¡æœ‰æ›´å¤šäº† â€”</text>
    </view>
  </view>
</view>
