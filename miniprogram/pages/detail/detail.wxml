<!-- é¥°å“è¯¦æƒ…é¡µ -->
<view class="detail-page">
  <!-- åŠ è½½ä¸­ -->
  <view class="loading-mask" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- è¯¦æƒ…å†…å®¹ -->
  <block wx:if="{{!loading && goodsDetail}}">
    <!-- å•†å“åŸºç¡€ä¿¡æ¯ -->
    <view class="goods-header">
      <view class="goods-image">
        <image src="{{goodsDetail.iconUrl}}" mode="aspectFit"></image>
      </view>
      <view class="goods-info">
        <text class="goods-name">{{goodsDetail.name}}</text>
        <view class="goods-meta">
          <view class="meta-item">
            <text class="meta-label">å“è´¨ï½œ</text>
            <text class="meta-value rarity" style="color: {{goodsDetail.rarityColor || '#333'}}">{{goodsDetail.rarityName || '-'}}</text>
          </view>
          <view class="meta-divider"></view>
          <view class="meta-item">
            <text class="meta-label">ç±»åˆ«ï½œ</text>
            <text class="meta-value">{{goodsDetail.qualityName || '-'}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ç£¨æŸ/å“è´¨åˆ‡æ¢ - æ”¾åœ¨é¥°å“ä¸‹æ–¹ -->
    <view class="wear-card" wx:if="{{hasWearOptions || hasOtherQuality}}">
      <view class="wear-selector">
        <!-- ç£¨æŸé€‰é¡¹ -->
        <block wx:if="{{hasWearOptions}}">
          <view 
            class="wear-btn {{item.isActive ? 'active' : ''}}"
            wx:for="{{currentQualityWears}}"
            wx:key="hash_name"
            data-hashname="{{item.hash_name}}"
            bindtap="switchWear"
          >
            <text class="wear-label">{{item.label}}</text>
            <text class="wear-price">Â¥{{item.priceText}}</text>
          </view>
        </block>
        
        <!-- StatTrak/çºªå¿µå“ åˆ‡æ¢æŒ‰é’® -->
        <view 
          class="wear-btn stattrak-btn"
          wx:if="{{hasOtherQuality}}"
          bindtap="toggleQuality"
        >
          <text class="wear-label"><text class="switch-icon">â‡„</text> {{otherQualityLabel}}</text>
          <text class="wear-price" wx:if="{{otherQualityMinPrice > 0}}">Â¥{{otherQualityMinPrice}}</text>
        </view>
      </view>
    </view>

    <!-- ä»·æ ¼æ¶¨å¹… -->
    <view class="price-change-card" wx:if="{{goodsDetail.priceChange && goodsDetail.priceChange.length > 0}}">
      <view class="price-change-nav">
        <view class="nav-arrow nav-left" wx:if="{{goodsDetail.priceChange.length > 2}}">
          <text>â€¹</text>
        </view>
        <scroll-view class="price-change-scroll" scroll-x enable-flex enhanced show-scrollbar="{{false}}">
          <view class="price-change-list">
            <view 
              class="price-change-item {{item.isUp ? 'is-up' : 'is-down'}}" 
              wx:for="{{goodsDetail.priceChange}}" 
              wx:key="label"
            >
              <view class="change-label">
                <text>{{item.label}}</text>
                <text class="change-icon {{item.isUp ? 'icon-up' : 'icon-down'}}">{{item.isUp ? 'â–²' : 'â–¼'}}</text>
              </view>
              <view class="change-value {{item.isUp ? 'text-red' : 'text-green'}}">
                <text class="price-diff">Â¥{{item.priceDiffText}}</text>
                <text class="change-rate">({{item.changeRateText}})</text>
              </view>
            </view>
          </view>
        </scroll-view>
        <view class="nav-arrow nav-right" wx:if="{{goodsDetail.priceChange.length > 2}}">
          <text>â€º</text>
        </view>
      </view>
    </view>

    <!-- ä»·æ ¼èµ°åŠ¿å›¾ -->
    <view class="chart-card">
      <view class="card-title">ä»·æ ¼èµ°åŠ¿</view>
      <!-- é€‰æ‹©å™¨ -->
      <view class="chart-filters">
        <picker 
          class="chart-picker" 
          mode="selector" 
          range="{{platforms}}" 
          range-key="label"
          value="{{selectedPlatformIndex}}"
          bindchange="onPlatformChange"
        >
          <view class="picker-content">
            <image class="picker-icon" src="{{platformIconMap[platforms[selectedPlatformIndex].value]}}" mode="aspectFit"></image>
            <text class="picker-text">{{platforms[selectedPlatformIndex].label}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
        <picker 
          class="chart-picker" 
          mode="selector" 
          range="{{timeRanges}}" 
          range-key="label"
          value="{{selectedTimeIndex}}"
          bindchange="onTimeChange"
        >
          <view class="picker-content">
            <text class="picker-text">{{timeRanges[selectedTimeIndex].label}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
      <!-- å›¾è¡¨åŒºåŸŸ -->
      <view class="chart-container">
        <canvas 
          id="priceChart" 
          type="2d" 
          class="price-chart"
          bindtouchstart="onChartTouch"
          bindtouchmove="onChartTouch"
          bindtouchend="onChartTouchEnd"
        ></canvas>
        <!-- æ•°æ®æç¤ºæ¡† -->
        <view class="chart-tooltip" wx:if="{{showTooltip}}" style="left: {{tooltipX}}px; top: {{tooltipY}}px;">
          <view class="tooltip-date">{{tooltipData.date}}</view>
          <view class="tooltip-price">ä»·æ ¼ï¼šÂ¥{{tooltipData.price}}</view>
          <view class="tooltip-count">åœ¨å”®ï¼š{{tooltipData.count}}ä»¶</view>
        </view>
      </view>
    </view>

    <!-- å¸‚åœºå¯¹æ¯” -->
    <view class="market-card">
      <view class="card-title">å¸‚åœºå¯¹æ¯”</view>
      <view class="market-list">
        <view 
          class="market-item" 
          wx:for="{{goodsDetail.platformList}}" 
          wx:key="platform"
        >
          <view class="market-item-header">
            <view class="platform-info">
              <image class="platform-icon" src="{{item.icon}}" mode="aspectFit"></image>
              <text class="platform-name">{{item.platformName}}</text>
            </view>
          </view>
          <view class="market-item-price">
            <text class="price-value">Â¥ {{item.sellPriceText}}</text>
            <view class="lowest-badge" wx:if="{{item.isLowest}}">åº•</view>
          </view>
          <view class="market-item-footer">
            <text class="sell-count">åœ¨å”®ï¼š{{item.sellCount}}</text>
            <text class="update-time">{{item.updateTimeText}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å½“å‰åœ¨å”® -->
    <view class="onsale-card">
      <view class="card-title">å½“å‰åœ¨å”®</view>
      <view class="onsale-table">
        <view class="table-header">
          <text class="col-source">æ¥æº</text>
          <text class="col-price">å”®ä»·</text>
          <text class="col-bid">æ±‚è´­ä»·</text>
          <text class="col-count">åœ¨å”®</text>
        </view>
        <view 
          class="table-row" 
          wx:for="{{goodsDetail.platformList}}" 
          wx:key="platform"
        >
          <view class="col-source">
            <image class="platform-icon-small" src="{{item.icon}}" mode="aspectFit"></image>
            <text class="platform-name-small">{{item.platformName}}</text>
          </view>
          <text class="col-price text-orange">Â¥{{item.sellPriceText}}</text>
          <text class="col-bid text-orange">Â¥{{item.biddingPriceText}}</text>
          <text class="col-count">{{item.sellCount}}ä»¶</text>
        </view>
      </view>
    </view>

  </block>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty" wx:if="{{!loading && !goodsDetail}}">
    <text class="empty-icon">ğŸ“¦</text>
    <text class="empty-text">æš‚æ— æ•°æ®</text>
  </view>
</view>
